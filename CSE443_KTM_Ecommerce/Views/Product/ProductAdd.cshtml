@model CSE443_KTM_Ecommerce.Models.Product
@{
    Layout = "AdminLayout";
}
<div class="page-content">
    <div class="container-xxl">
        <div class="row">
            <div class="col-xl-12">

                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Product Information</h4>
                    </div>
                    <div class="card-body">
                        <form asp-action="ProductAdd" asp-controller="Product" method="post" id="productForm" enctype="multipart/form-data">
                            @Html.AntiForgeryToken()
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <div class="card">
                                <div class="card-body">
                                        <div class="fallback">
                                            <input name="files" type="file" multiple="multiple">
                                        </div>
                                        @* <div class="dz-message needsclick"> *@
                                        @*     <i class="bx bx-cloud-upload fs-48 text-primary"></i> *@
                                        @*     <h3 class="mt-4">Drop your images here, or <span class="text-primary">click to browse</span></h3> *@
                                        @*     <span class="text-muted fs-13">PNG, JPG and GIF files are allowed</span> *@
                                        @* </div> *@
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="Name" class="form-label">Product Name</label>
                                        <input asp-for="Name" class="form-control" placeholder="Enter product name" required />
                                        <span asp-validation-for="Name" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="CategoryId" class="form-label">Category</label>
                                        <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.Categories" required>
                                            <option value="">Select Category</option>
                                        </select>
                                        <span asp-validation-for="CategoryId" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="Brand" class="form-label">Brand</label>
                                        <input asp-for="Brand" class="form-control" placeholder="Enter brand" required />
                                        <span asp-validation-for="Brand" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="Weight" class="form-label">Weight</label>
                                        <input asp-for="Weight" class="form-control" placeholder="Enter weight" required />
                                        <span asp-validation-for="Weight" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="Warranty" class="form-label">Warranty</label>
                                        <input asp-for="Warranty" class="form-control" placeholder="Enter warranty" required />
                                        <span asp-validation-for="Warranty" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="Size" class="form-label">Size</label>
                                        <input asp-for="Size" class="form-control" placeholder="Enter size" required />
                                        <span asp-validation-for="Size" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="Price" class="form-label">Price</label>
                                        <input asp-for="Price" class="form-control" type="number" step="0.01" placeholder="Enter price" required />
                                        <span asp-validation-for="Price" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="Quantity" class="form-label">Quantity</label>
                                        <input asp-for="Quantity" class="form-control" type="number" placeholder="Enter quantity" required />
                                        <span asp-validation-for="Quantity" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Description" class="form-label">Description</label>
                                <textarea asp-for="Description" class="form-control" rows="3" placeholder="Enter description" required></textarea>
                                <span asp-validation-for="Description" class="text-danger"></span>
                            </div>

                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="Fabric" class="form-label">Fabric</label>
                                        <input asp-for="Fabric" class="form-control" placeholder="Enter fabric" required />
                                        <span asp-validation-for="Fabric" class="text-danger"></span>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label asp-for="ProductTypeId" class="form-label">Product Type</label>
                                        <select asp-for="ProductTypeId" class="form-control" asp-items="ViewBag.ProductTypes" required>
                                            <option value="">Select Product Type</option>
                                        </select>
                                        <span asp-validation-for="ProductTypeId" class="text-danger"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Dimensions" class="form-label">Dimensions</label>
                                <input asp-for="Dimensions" class="form-control" placeholder="Enter dimensions" required />
                                <span asp-validation-for="Dimensions" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <div class="form-check">
                                    <input asp-for="Featured" class="form-check-input" type="checkbox" />
                                    <label asp-for="Featured" class="form-check-label">Featured Product</label>
                                </div>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-primary">Add Product</button>
                                <a asp-action="ProductList" class="btn btn-secondary">Cancel</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" />

    <script>
        Dropzone.autoDiscover = false;

        const myDropzone = new Dropzone("#dropzone", {
            url: "/Product/ProductAdd",
            autoProcessQueue: false,
            uploadMultiple: true,
            addRemoveLinks: true,
            paramName: "files",
            acceptedFiles: "image/*",
            headers: {
                'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val()
            },
            init: function () {
                const dz = this;

                dz.on("sending", function (file, xhr, formData) {
                    // Lấy dữ liệu từ form và append vào request
                    $('#productForm').serializeArray().forEach(input => {
                        formData.append(input.name, input.value);
                    });
                });

                dz.on("successmultiple", function (files, response) {
                    if (response.success) {
                        alert("Thêm sản phẩm và ảnh thành công!");
                        window.location.href = '/Product/ProductList';
                    } else {
                        alert("Lỗi: " + (response.message || "Không rõ"));
                    }
                });

                dz.on("errormultiple", function (files, response) {
                    alert("Lỗi khi upload ảnh");
                });

                $('#productForm').on('submit', function (e) {
                    e.preventDefault();
                    if (!$(this).valid()) return;

                    if (dz.getQueuedFiles().length > 0) {
                        dz.processQueue(); // Dropzone tự gửi ảnh + form
                    } else {
                        // Gửi form nếu không có ảnh
                        const formData = $(this).serialize();
                        $.post("/Product/ProductAdd", formData, function (response) {
                            if (response.success) {
                                alert("Thành công!");
                                window.location.href = '/Product/ProductList';
                            } else {
                                alert("Lỗi: " + (response.message || "Không rõ"));
                            }
                        });
                    }
                });
            }
        });

        function deleteImage(event, imageNumber) {
            if (confirm('Are you sure you want to delete this image?')) {
                $(event.target).closest('.position-relative').remove();
            }
        }
    </script>
}
